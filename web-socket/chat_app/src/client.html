<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js" type="module"></script>
    <title>Socket.IO chat</title>
    <style>
      html, body { 
        display: flex; 
        flex-direction: column; 
        height: 100%; 
        margin: 0; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        min-width: 300px;
      }

      #chat-container {
        display: flex;
        flex-grow: 1;
        overflow: hidden;
      }

      #sidebar {
        position: relative;
        width: 200px;
        background: #f0f0f0;
        padding: 1rem;
        overflow-y: auto;
        border-right: 1px solid #ddd;
        min-width: 150px;
      }

      #main-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }

      #form { 
        background: rgba(0, 0, 0, 0.15); 
        padding: 0.25rem;
        flex-shrink: 0;
        height: 3rem;
        min-height: 3rem;
        display: flex; 
        height: 5%; 
        box-sizing: border-box; 
        backdrop-filter: blur(10px); 
      }

      #myFile {
        align-self: center;
      }

      #input { 
        border: none; 
        padding: 0 1rem; 
        flex-grow: 1; 
        border-radius: 2rem; 
        margin: 0.25rem; 
      }

      #input:focus { 
        outline: none; 
      }

      #form > button { 
        background: #333; 
        border: none; 
        padding: 0 1rem; 
        margin: 0.25rem; 
        border-radius: 3px; 
        outline: none; 
        color: #fff; 
      }

      #messages {
        flex-grow: 1;
        display: flex; 
        flex-direction: column; 
        margin: 0; 
        padding: 0; 
        overflow-y: auto;
      }

      #typing-info-container {
        flex-shrink: 1;
      }

      #typing-info {
        list-style-type: none;
        font-style: italic;
        color: gray;
      }

      .message {
        display: inline-block;
        align-self: flex-start;
        background: #8263ff;
        padding: 0.5rem 1rem;
        margin: 0.5rem 1rem;
        border-radius: 20px;
        max-width: 70%;
        word-wrap: break-word;
        overflow-wrap: break-word;
        word-break: break-word;
        white-space: pre-wrap;
        cursor: pointer;
      }

      .message .content {
        white-space: pre-wrap;
        overflow: hidden;
      }

      .message.author {
        background: #59a0fb;
        align-self: flex-end;
      }

      .message {
        color: white;
      }

      .message > .author {
        font-weight: bold;
      }

      .message > .timestamp {
        font-style: italic;
        color: #ffffff;
        font-size: 0.8rem;
      }

      .room-list {
        list-style: none;
        padding: 0;
      }

      .room-list li {
        padding: 0.5rem;
        cursor: pointer;
        border-radius: 4px;
        margin-bottom: 0.25rem;
      }

      .room-list li:hover {
        background: #ddd;
      }

      .room-list li.active {
        background: #59a0fb;
        color: white;
      }

      .user-list {
        list-style: none;
        padding: 0;
        margin-top: 1rem;
      }

      .user-list li {
        padding: 0.25rem 0.5rem;
        font-size: 0.9rem;
      }

      .notification {
        align-self: center;
        background: #e0e0e0;
        color: #555;
        padding: 0.25rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        margin: 0.5rem 0;
      }

      .image {
        max-width: 100%;
        border-radius: 8px;
        margin-top: 0.5rem;
      }

      #room-form {
        display: flex;
        margin-bottom: 1rem;
        min-width: 0;
      }

      #new-room-input {
        flex-grow: 1;
        padding: 0.25rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-width: 0;
      }

      #new-room-button {
        margin-left: 0.5rem;
        background: #59a0fb;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 0 0.75rem;
        white-space: nowrap;
        flex-shrink: 0;
      }

      #nickname-display {
        position: absolute;
        bottom: 1rem;
      }

      /* Styl dla odpowiedzi */
      .reply-info {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        margin-bottom: 0.25rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .reply-content {
        font-style: italic;
      }

      /* Styl dla wybranej wiadomoÅ›ci do odpowiedzi */
      .message.selected {
        box-shadow: 0 0 0 2px #000000;
      }

      /* Styl dla paska informacji o odpowiedzi */
      #reply-preview {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #e0e0e0;
        padding: 0.25rem 1rem;
        font-size: 0.9rem;
      }

      #reply-preview-content {
        flex-grow: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #cancel-reply {
        background: none;
        border: none;
        color: #555;
        cursor: pointer;
        margin-left: 0.5rem;
        font-size: 1.2rem;
        padding: 0 0.5rem;
        line-height: 1;
        border-radius: 50%;
        transition: all 0.2s;
      }

      #cancel-reply:hover {
        background: rgba(0, 0, 0, 0.1);
        color: #333;
      }

      @media (max-width: 768px) {
        #form {
          flex-wrap: wrap;
          height: auto;
          min-height: 5rem;
          padding: 0.5rem;
        }
        
        #input {
          width: 100%;
          order: 1;
          margin-bottom: 0.25rem;
        }
        
        #myFile {
          flex-grow: 1;
          order: 2;
          min-width: 0;
        }
        
        #form > button {
          order: 3;
          flex-grow: 1;
        }
        
        .message {
          max-width: 85%;
        }

        emoji-picker {
          width: 90%;
          right: 0;
          bottom: 4rem;
        }
      }

      .hidden {
        display: none !important;
      }

      emoji-picker {
        --emoji-size: 1.5rem;
        --num-columns: 8;
        --category-emoji-size: 1.2rem;
        position: absolute;
        bottom: 3.5rem;
        right: 1rem;
        z-index: 100;
      }

      .emoji-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        padding: 0 0.5rem;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="chat-container">
      <div id="sidebar">
        <h3>Rooms</h3>
        <div id="room-form">
          <input type="text" id="new-room-input" placeholder="New room name">
          <button id="new-room-button">+</button>
        </div>
        <ul class="room-list" id="room-list"></ul>
        <h3>Users in room</h3>
        <ul class="user-list" id="user-list"></ul>
        <div id="nickname-display">
          <h3>Nickname:</h3>
          <p id="username"></p>
        </div>
      </div>
      <div id="main-content">
        <ul id="messages"></ul>
        <div id="typing-info-container"><ul id="typing-info"></ul></div>
        <div id="reply-preview" class="hidden">
          <div id="reply-preview-content">Replying to: <span id="reply-preview-text"></span></div>
          <button id="cancel-reply">Ã—</button>
        </div>
        <emoji-picker id="emoji-picker" class="hidden"></emoji-picker>
        <form id="form" action="">
          <input id="input" autocomplete="off" placeholder="Type your message..." />
          <button type="button" id="emoji-button" class="emoji-btn">ðŸ˜€</button>
          <input type="file" id="myFile" name="filename" accept="image/*">
          <button>Send</button>
        </form>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      let nickname = prompt("Enter your nickname:", "User" + Math.floor(Math.random() * 1000));
      nickname = nickname == null || nickname == "" ? "anonymous" : nickname;
      document.getElementById('username').textContent = nickname;
      
      let currentRoom = 'general';
      let replyToMessage = null; // Przechowuje wiadomoÅ›Ä‡, na ktÃ³rÄ… odpowiadamy
      var socket = io();

      var messages = document.getElementById('messages');
      var typingInfo = document.getElementById('typing-info');
      var form = document.getElementById('form');
      var input = document.getElementById('input');
      var fileUpload = document.getElementById('myFile');
      var roomList = document.getElementById('room-list');
      var userList = document.getElementById('user-list');
      var newRoomInput = document.getElementById('new-room-input');
      var newRoomButton = document.getElementById('new-room-button');
      var replyPreview = document.getElementById('reply-preview');
      var replyPreviewText = document.getElementById('reply-preview-text');
      var cancelReplyButton = document.getElementById('cancel-reply');

      let currentFile;
      let typingInfosTimeoutData = {};
      const TYPING_INFO_TIMEOUT = 2000; //ms

      // DoÅ‚Ä…cz do domyÅ›lnego pokoju
      socket.emit('join', { nickname, room: currentRoom });

      // SOCKET INPUT LISTENERS...
      socket.on('chat message', (msg) => {
        if (msg.room === currentRoom) {
          addMessageItemToHTML(msg, msg.author === nickname);
          if (typingInfosTimeoutData[msg.author]) {
            const [info, timeoutId] = typingInfosTimeoutData[msg.author];
            removeTypingInfo(msg.author, info);
            clearTimeout(timeoutId);
          }
        }
      });

      socket.on('typing', (typingNickname) => {
        // Pokazuj informacjÄ™ tylko jeÅ›li to nie my piszemy
        if (typingNickname !== nickname) {
          showTypingInfoHTML(typingNickname);
        }
      });

      socket.on('user joined', (nickname) => {
        addNotification(`${nickname} joined the room`);
      });

      socket.on('user left', (nickname) => {
        addNotification(`${nickname} left the room`);
      });

      socket.on('room users', (users) => {
        updateUserList(users);
      });

      socket.on('room list', (rooms) => {
        updateRoomList(rooms);
      });

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        if ((input.value && input.value.trim() !== '') || currentFile) {
          const msg = {
            'author': nickname,
            'content': input.value,
            'image': currentFile ? 
            {
              'data': currentFile.data,
              'type': currentFile.type
            } : null,
            'timestamp': new Date(),
            'room': currentRoom,
            'replyTo': replyToMessage ? {
              'id': replyToMessage.id,
              'author': replyToMessage.author,
              'content': replyToMessage.content
            } : null
          };
          socket.emit('chat message', msg);
          input.value = '';
          currentFile = null;
          fileUpload.value = '';
          cancelReply();
        }
      });

      input.addEventListener('input', (event) => {
        socket.emit('typing', nickname);
      });

      fileUpload.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.type.match('image.*')) {
          alert("Please upload an image file");
          event.target.value = '';
          currentFile = null;
          return;
        }
        const reader = new FileReader();
        
        reader.onload = (e) => {
          currentFile = {
            'data': e.target.result,
            'type': file.type
          };
        };

        reader.onerror = () => {
          alert("Error reading file");
          event.target.value = '';
          currentFile = null;
        };

        reader.readAsArrayBuffer(file);
      });

      newRoomButton.addEventListener('click', () => {
        const roomName = newRoomInput.value.trim();
        if (roomName && roomName !== currentRoom) {
          joinRoom(roomName);
          newRoomInput.value = '';
        }
      });

      cancelReplyButton.addEventListener('click', cancelReply);

      function joinRoom(room) {
        socket.emit('join', { nickname, room });
        currentRoom = room;
        messages.innerHTML = '';
        addNotification(`You joined ${room}`);
        cancelReply();
      }

      function updateRoomList(rooms) {
        roomList.innerHTML = '';
        rooms.forEach(room => {
          const li = document.createElement('li');
          li.textContent = room;
          if (room === currentRoom) {
            li.classList.add('active');
          }
          li.addEventListener('click', () => {
            if (room !== currentRoom) {
              joinRoom(room);
            }
          });
          roomList.appendChild(li);
        });
      }

      function updateUserList(users) {
        userList.innerHTML = '';
        users.forEach(user => {
          const li = document.createElement('li');
          li.textContent = user;
          userList.appendChild(li);
        });
      }

      function addMessageItemToHTML(msg, author=false) {
        const item = createMessageItem(msg);
        messages.appendChild(item);
        messages.scrollTo(0, messages.scrollHeight);
        if (author) item.classList.add('author');
        
        // Dodaj unikalne ID do wiadomoÅ›ci
        const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        item.id = messageId;
        msg.id = messageId; // Dodaj ID do obiektu wiadomoÅ›ci
        
        // ObsÅ‚uga klikniÄ™cia na wiadomoÅ›Ä‡
        item.addEventListener('click', () => {
          // UsuÅ„ podÅ›wietlenie z poprzednio wybranej wiadomoÅ›ci
          const previouslySelected = document.querySelector('.message.selected');
          if (previouslySelected) {
            previouslySelected.classList.remove('selected');
          }
          
          // PodÅ›wietl wybranÄ… wiadomoÅ›Ä‡
          item.classList.add('selected');
          
          // Ustaw jako wiadomoÅ›Ä‡ do odpowiedzi
          replyToMessage = msg;
          
          // PokaÅ¼ podglÄ…d odpowiedzi
          replyPreviewText.textContent = msg.content.length > 12 
            ? msg.content.substring(0, 12) + '...' 
            : msg.content;
          replyPreview.classList.remove('hidden');
        });
      }

      function createMessageItem(msg) {
        const item = document.createElement('li');
        item.className = 'message';

        // Dodaj informacjÄ™ o odpowiedzi jeÅ›li istnieje
        if (msg.replyTo) {
          const replyInfo = document.createElement('div');
          replyInfo.className = 'reply-info';
          replyInfo.textContent = `Replying to ${msg.replyTo.author}: ${msg.replyTo.content.length > 10 ? msg.replyTo.content.substring(0, 10) + '...' : msg.replyTo.content}`;
          item.appendChild(replyInfo);
        }

        const author = document.createElement('div');
        author.className = 'author';
        author.textContent = msg.author;
        item.appendChild(author);

        const content = document.createElement('div');
        content.className = 'content';
        content.textContent = msg.content;
        item.appendChild(content);

        if (msg.image) {
          const blob = new Blob([msg.image.data], { type: msg.image.type });
          const imgURL = URL.createObjectURL(blob);

          const img = document.createElement('img');
          img.src = imgURL;
          img.alt = 'attachment';
          img.className = 'image';
          
          item.append(img);
        }

        const date = document.createElement('div');
        date.className = 'timestamp';
        date.textContent = new Date(msg.timestamp).toLocaleTimeString();
        item.appendChild(date);

        return item;
      }

      function showTypingInfoHTML(nickname) {
        let currentInfo;
        
        if (typingInfosTimeoutData[nickname]) {
          let currentTimeoutId;
          [currentInfo, currentTimeoutId] = typingInfosTimeoutData[nickname];
          clearTimeout(currentTimeoutId);
        }
        else {
          currentInfo = document.createElement('li');
          currentInfo.textContent = `${nickname} is typing...`;
          typingInfo.appendChild(currentInfo);
        }
        
        typingInfosTimeoutData[nickname] = [currentInfo, setTimeout(() => removeTypingInfo(nickname, currentInfo), TYPING_INFO_TIMEOUT)];
      }

      function removeTypingInfo(nickname, info) {
        info.remove();
        typingInfosTimeoutData[nickname] = null;
      }

      function addNotification(text) {
        const notification = document.createElement('li');
        notification.className = 'notification';
        notification.textContent = text;
        messages.appendChild(notification);
        messages.scrollTo(0, messages.scrollHeight);
      }

      function cancelReply() {
        replyToMessage = null;
        replyPreview.classList.add('hidden');
        const selected = document.querySelector('.message.selected');
        if (selected) {
          selected.classList.remove('selected');
        }
      }

      // ObsÅ‚uga emoji pickera
      const picker = document.getElementById('emoji-picker');
      const emojiButton = document.getElementById('emoji-button');

      emojiButton.addEventListener('click', () => {
        picker.classList.toggle('hidden');
      });

      picker.addEventListener('emoji-click', event => {
        input.value += event.detail.unicode;
        picker.classList.add('hidden');
      });

      // Zamknij picker przy klikniÄ™ciu gdzie indziej
      document.addEventListener('click', (e) => {
        if (!picker.contains(e.target) && e.target !== emojiButton) {
          picker.classList.add('hidden');
        }
      });
    </script>
  </body>
</html>